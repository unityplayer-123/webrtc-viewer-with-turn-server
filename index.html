<script>
  const signalingUrl = "wss://webrtc-signaling-server-va4t.onrender.com";

  // STUN/TURN サーバー設定
  const pc = new RTCPeerConnection({
    iceServers: [
      { urls: ["stun:openrelay.metered.ca:80"] },
      {
        urls: [
          "turn:openrelay.metered.ca:80",
          "turn:openrelay.metered.ca:443",
          "turn:openrelay.metered.ca:443?transport=tcp"
        ],
        username: "openrelayproject",
        credential: "openrelayproject"
      }
    ]
  });

  const videoEl = document.getElementById("remoteVideo");

  // Unityからの映像を受信
  pc.ontrack = (event) => {
    videoEl.srcObject = event.streams[0];
    console.log("Remote stream attached");
  };

  // ICE候補をシグナリングサーバーへ送信
  pc.onicecandidate = (event) => {
    if (event.candidate) {
      ws.send(JSON.stringify({
        type: "candidate",
        candidate: event.candidate.candidate,
        sdpMid: event.candidate.sdpMid,
        sdpMLineIndex: event.candidate.sdpMLineIndex
      }));
    }
  };

  // WebSocketでシグナリング
  const ws = new WebSocket(signalingUrl);
  ws.onopen = () => {
    console.log("Connected to signaling server");
  };

  ws.onmessage = async (msg) => {
    const data = JSON.parse(msg.data);

    if (data.type === "offer") {
      console.log("Received offer from Unity");
      await pc.setRemoteDescription(data);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      ws.send(JSON.stringify({
        type: "answer",
        sdp: answer.sdp
      }));
      console.log("Answer sent to Unity");
    } else if (data.type === "candidate") {
      try {
        await pc.addIceCandidate(data);
        console.log("ICE candidate added");
      } catch (err) {
        console.error("Error adding ICE candidate:", err);
      }
    }
  };
</script>

