<script>
  const signalingUrl = "wss://webrtc-signaling-server-va4t.onrender.com";

  // STUN/TURN サーバー設定
  const pc = new RTCPeerConnection({
    iceServers: [
      { urls: ["stun:stun.l.google.com:19302"] },
      {
        urls: [
          "turn:openrelay.metered.ca:80",
          "turn:openrelay.metered.ca:443",
          "turn:openrelay.metered.ca:443?transport=tcp"
        ],
        username: "openrelayproject",
        credential: "openrelayproject"
      }
    ]
  });

  const videoEl = document.getElementById("remoteVideo");

  // Unityからの映像を受信
  pc.ontrack = (event) => {
    videoEl.srcObject = event.streams[0];
    console.log("Remote stream attached");
  };

  // ICE候補をシグナリングサーバーへ送信
  pc.onicecandidate = (event) => {
    if (event.candidate) {
      ws.send(JSON.stringify({
        type: "candidate",
        candidate: event.candidate.candidate,
        sdpMid: event.candidate.sdpMid,
        sdpMLineIndex: event.candidate.sdpMLineIndex
      }));
    }
  };

  // WebSocketでシグナリング
  const ws = new WebSocket(signalingUrl);
  ws.onopen = () => {
    console.log("Connected to signaling server");
  };

  ws.onmessage = async (msg) => {
    const data = JSON.parse(msg.data);

    if (data.type === "offer") {
      console.log("Received offer from Unity");

      // UnityのOfferは { type:"offer", sdp:"..." }
      await pc.setRemoteDescription({ type: "offer", sdp: data.sdp });

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      // Answerは { type:"answer", sdp:"..." }
      ws.send(JSON.stringify({
        type: "answer",
        sdp: answer.sdp
      }));
      console.log("Answer sent to Unity");

    } else if (data.type === "candidate") {
      // Candidateは { type:"candidate", candidate:"...", sdpMid:"...", sdpMLineIndex:0 }
      try {
        await pc.addIceCandidate({
          candidate: data.candidate,
          sdpMid: data.sdpMid,
          sdpMLineIndex: data.sdpMLineIndex
        });
        console.log("ICE candidate added");
      } catch (err) {
        console.error("Error adding ICE candidate:", err);
      }
    }
  };
</script>


