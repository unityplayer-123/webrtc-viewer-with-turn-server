<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebRTC Viewer</title>
</head>
<body>
  <h2>Unity WebRTC Viewer</h2>
  <video id="remoteVideo" autoplay playsinline controls></video>

  <script>
    const signalingUrl = "wss://webrtc-signaling-server-va4t.onrender.com"; 
    const ws = new WebSocket(signalingUrl);

    let pc = null;

    ws.onopen = () => {
      console.log("[WebSocket] Connected to signaling server");
    };

    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);
      console.log("[WebSocket] Received:", msg);

      if (msg.type === "offer") {
        console.log("[WebRTC] Received offer from Unity");

        // PeerConnection作成
        pc = new RTCPeerConnection();

        // リモートストリームを <video> にセット
        pc.ontrack = (event) => {
          console.log("[WebRTC] Remote track received");
          document.getElementById("remoteVideo").srcObject = event.streams[0];
        };

        // DataChannel用の受信確認（任意）
        pc.ondatachannel = (event) => {
          const channel = event.channel;
          channel.onmessage = (e) => console.log("[DataChannel]", e.data);
        };

        // UnityからのOfferを適用
        await pc.setRemoteDescription(new RTCSessionDescription(msg));

        // Answerを作成して送信
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        ws.send(JSON.stringify({
          type: "answer",
          sdp: answer.sdp
        }));
        console.log("[WebRTC] Answer sent");
      }
      else if (msg.type === "candidate" && pc) {
        console.log("[WebRTC] Adding ICE candidate");
        try {
          await pc.addIceCandidate(msg.candidate);
        } catch (err) {
          console.error("Error adding ICE candidate:", err);
        }
      }
    };
  </script>
</body>
</html>

